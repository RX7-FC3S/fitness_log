import{c as ee,u as ae,r as p,a as _,b as de,d as ue,e as ve,o as pe,w as X,f as fe,g as S,h as n,i as d,j as s,F as Y,k as Z,l as k,m as G,n as me,p as N,q as x,s as h,v as $,t as T,x as ce,y as w,z as ge,_ as ye}from"./index-Bbbvtfa9.js";import{P as ke,a as we,T as be}from"./trash-2--WzwhY8Z.js";const xe=ee("circle-check-big",[["path",{d:"M21.801 10A10 10 0 1 1 17 3.335",key:"yps3ct"}],["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}]]);const Se=ee("message-square",[["path",{d:"M22 17a2 2 0 0 1-2 2H6.828a2 2 0 0 0-1.414.586l-2.202 2.202A.71.71 0 0 1 2 21.286V5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2z",key:"18887p"}]]);function Te(){const P=ue(),b=ae(),l=p(null),f=p(null),C=()=>l.value?.primaryMuscles?.length?M(l.value.primaryMuscles):b.primaryMuscles||[],M=i=>i.map(t=>typeof t=="object"?t.name:String(t)),L=()=>{const i=C();let t="";const u=l.value?.id?l.value.date:f.value||l.value?.date;i.length&&(t=i.join(" + ")),u&&(t=`${u}${t?" - "+t:""}`),b.setPageTitle(t)},V=async i=>{try{const t=i?await _.getFitnessDay(i):await _.getTodayFitnessDay(f.value||void 0);l.value=t,L()}catch(t){console.error("Failed to load training data",t)}finally{b.hideLoading()}},R=de(()=>{const i=C();return i.length?[...b.exercises].sort((t,u)=>{const c=i.includes(t.targetMuscle),I=i.includes(u.targetMuscle);return c===I?t.name.localeCompare(u.name):c?-1:1}):b.exercises});return{dayData:l,sortedExercises:R,loadData:V,addSet:async i=>{const t={fitness_day_id:l.value?.id||void 0,exercise_id:Number(i.exercise_id),set_type:i.set_type,weight:Number(i.weight),reps:Number(i.reps),unit_id:Number(i.unit_id),remark:"",date:f.value||void 0,primary_muscles:C()},u=await _.createFitnessSet(t);return!l.value?.id&&u.fitnessDayId?P.replace(`/training/${u.fitnessDayId}`):await V(l.value?.id||u.fitnessDayId),u},finishTraining:async()=>{if(!l.value?.id){b.showToast("训练记录未创建");return}await _.finishFitnessDay(l.value.id),P.replace("/")},deleteSet:async(i,t)=>{await _.deleteFitnessSet(i),t?P.replace("/"):await V(l.value?.id)},updateSet:async(i,t)=>{await _.updateFitnessSet(i,t),await V(l.value?.id)},resolvePrimaryMuscles:C,targetDate:f}}const Ce={class:"training-page"},Ve={class:"form-grid-2"},Fe={class:"form-grid-3"},_e={class:"scroll-area",id:"sets-list-container"},De={class:"group-title f-title"},Ie={class:"set-card-content"},he={class:"set-info-row"},$e={class:"set-details"},Pe={key:0,class:"set-remark"},Me={class:"set-actions"},Ue={key:0,class:"empty-state"},ze={class:"dialog-content"},Be={class:"form-group"},Ee={class:"dialog-actions"},Ne={key:0,class:"dialog-title f-title is-primary"},Le={class:"form-group"},Re={class:"form-group"},je={class:"form-group"},Ae={class:"form-group"},qe={class:"dialog-actions"},He={key:0,class:"dialog-content"},We={class:"dialog-actions-vertical"},Ge={key:1,class:"dialog-content"},Je={class:"dialog-actions"},Ke=ve({__name:"Training",setup(P){const b=me(),l=ae(),{dayData:f,sortedExercises:C,loadData:M,addSet:L,finishTraining:V,deleteSet:R,updateSet:j,targetDate:J}=Te(),r=p({exerciseId:"",setType:l.setTypes[0]?.value||"正式组",unitId:l.units[0]?.id||1,weight:"",reps:""}),D=p(!1),i=p(!1),t=p(!1),u=p(!1),c=p(null),I=p(null),v=p({setType:"",weight:0,unitId:1,reps:0,remark:""}),A=p(!1),q=p(!1),U=p(!1),z=p(!1),F=p(!1),H=p(!1),se=async()=>{if(!r.value.exerciseId||r.value.weight===""||!r.value.reps){D.value=!0;return}q.value=!0;try{await L({exercise_id:r.value.exerciseId,set_type:r.value.setType||"正式组",weight:r.value.weight,reps:r.value.reps,unit_id:String(r.value.unitId)}),setTimeout(()=>{const o=document.getElementById("sets-list-container");o&&(o.scrollTop=o.scrollHeight)},100)}finally{q.value=!1}},le=o=>{c.value=o,v.value.remark=o.remark||"",i.value=!0},te=async()=>{if(c.value){U.value=!0;try{await j(c.value.id,{remark:v.value.remark}),i.value=!1}finally{U.value=!1}}},ie=(o,e)=>{I.value=o,c.value=e,v.value={setType:String(e.setType),weight:e.weight,unitId:typeof e.unit=="object"?e.unit.id:Number(e.unitId),reps:e.reps,remark:e.remark||""},t.value=!0},ne=async()=>{if(c.value){z.value=!0;try{await j(c.value.id,{set_type:v.value.setType,weight:v.value.weight,unit_id:v.value.unitId,reps:v.value.reps}),t.value=!1}finally{z.value=!1}}},oe=o=>{c.value={id:o};let e=0;f.value&&f.value.exercises.forEach(g=>e+=g.sets.length),A.value=e===1,u.value=!0},K=async()=>{if(c.value){F.value=!0;try{await R(c.value.id,A.value),u.value=!1}finally{F.value=!1}}},re=async()=>{H.value=!0;try{await V()}finally{H.value=!1}},O=o=>{const e=l.setTypes.find(B=>B.value===o)?.label||o;let g="badge-working";return o.includes("热身")&&(g="badge-warmup"),o.includes("失败")&&(g="badge-failure"),o.includes("递减")&&(g="badge-drop"),{label:e,class:g}},W=()=>{l.setPageFooter([f.value?.id?{key:"finish",label:"结束训练",variant:"secondary",class:"flex-1",icon:xe,onClick:re,loading:H}:null,{key:"add",label:"添加此组",variant:"primary",class:f.value?.id?"flex-2":"flex-1",icon:ke,onClick:se,loading:q}].filter(Boolean))};return pe(async()=>{l.setPageTitle(""),l.setFooterVisible(!0);const o=b.query.date;o&&(J.value=o),await M(b.params.id),W(),l.setTypes.length>0&&l.setTypes[0]&&(r.value.setType=l.setTypes[0].value)}),X(()=>b.params.id,async o=>{await M(o),W()}),X(()=>f.value?.id,()=>{W()}),fe(()=>{l.clearPageFooter()}),(o,e)=>{const g=N("FSelect"),B=N("FCard"),y=N("FButton"),E=N("FDialog");return x(),S("div",Ce,[n(B,{variant:"header",class:"header-card"},{default:d(()=>[s("div",Ve,[n(g,{modelValue:r.value.exerciseId,"onUpdate:modelValue":e[0]||(e[0]=a=>r.value.exerciseId=a),options:k(C).map(a=>({value:a.id,label:a.name})),placeholder:"选择动作..."},null,8,["modelValue","options"]),n(g,{modelValue:r.value.setType,"onUpdate:modelValue":e[1]||(e[1]=a=>r.value.setType=a),options:k(l).setTypes},null,8,["modelValue","options"])]),s("div",Fe,[n(g,{modelValue:r.value.unitId,"onUpdate:modelValue":e[2]||(e[2]=a=>r.value.unitId=a),options:k(l).units.map(a=>({value:a.id,label:a.name}))},null,8,["modelValue","options"]),h(s("input",{type:"number",class:"form-input",placeholder:"重量",step:"0.5","onUpdate:modelValue":e[3]||(e[3]=a=>r.value.weight=a)},null,512),[[$,r.value.weight]]),h(s("input",{type:"number",class:"form-input",placeholder:"次数","onUpdate:modelValue":e[4]||(e[4]=a=>r.value.reps=a)},null,512),[[$,r.value.reps]])])]),_:1}),s("div",_e,[(x(!0),S(Y,null,Z(k(f)?.exercises,a=>(x(),S("div",{key:a.exercise.id,class:"exercise-group"},[s("h4",De,T(a.exercise.name),1),(x(!0),S(Y,null,Z(a.sets,m=>(x(),ce(B,{key:m.id,class:"set-card",padding:"0.75rem 1rem",margin:"0 0 0.5rem 0","border-radius":"1rem"},{default:d(()=>[s("div",Ie,[s("div",he,[s("span",$e,[w(T(m.weight)+" ",1),s("span",null,T(typeof m.unit=="object"?m.unit.name:m.unit),1),e[19]||(e[19]=s("span",{class:"multiply-sign"},"×",-1)),w(" "+T(m.reps)+" ",1),e[20]||(e[20]=s("span",null,"次",-1))]),s("span",{class:ge(["set-type-badge",O(String(m.setType)).class])},T(O(String(m.setType)).label),3)]),m.remark?(x(),S("div",Pe,T(m.remark),1)):G("",!0)]),s("div",Me,[n(y,{variant:"ghost",size:"icon",onClick:Q=>le(m)},{default:d(()=>[n(k(Se),{size:18})]),_:1},8,["onClick"]),n(y,{variant:"ghost",size:"icon",onClick:Q=>ie(a.exercise,m)},{default:d(()=>[n(k(we),{size:18})]),_:1},8,["onClick"]),n(y,{variant:"danger",size:"icon",onClick:Q=>oe(m.id)},{default:d(()=>[n(k(be),{size:18})]),_:1},8,["onClick"])])]),_:2},1024))),128))]))),128)),!k(f)||!k(f).exercises.length?(x(),S("div",Ue,"还没有记录，开始训练吧！")):G("",!0)]),n(E,{show:D.value,onClose:e[6]||(e[6]=a=>D.value=!1)},{default:d(()=>[s("div",ze,[e[22]||(e[22]=s("div",{class:"dialog-title f-title"},"提示",-1)),e[23]||(e[23]=s("div",{class:"dialog-message"},"请选择动作并填写重量和次数",-1)),n(y,{variant:"primary",class:"full-width",onClick:e[5]||(e[5]=a=>D.value=!1)},{default:d(()=>[...e[21]||(e[21]=[w("确认",-1)])]),_:1})])]),_:1},8,["show"]),n(E,{show:i.value,onClose:e[9]||(e[9]=a=>i.value=!1)},{default:d(()=>[e[26]||(e[26]=s("div",{class:"dialog-title f-title is-primary"},"添加/修改备注",-1)),s("div",Be,[h(s("textarea",{class:"form-input remark-textarea","onUpdate:modelValue":e[7]||(e[7]=a=>v.value.remark=a),placeholder:"输入备注内容..."},null,512),[[$,v.value.remark]])]),s("div",Ee,[n(y,{variant:"secondary",class:"flex-1",disabled:U.value,onClick:e[8]||(e[8]=a=>i.value=!1)},{default:d(()=>[...e[24]||(e[24]=[w(" 取消",-1)])]),_:1},8,["disabled"]),n(y,{variant:"primary",class:"flex-1",loading:U.value,onClick:te},{default:d(()=>[...e[25]||(e[25]=[w("保存",-1)])]),_:1},8,["loading"])])]),_:1},8,["show"]),n(E,{show:t.value,onClose:e[15]||(e[15]=a=>t.value=!1)},{default:d(()=>[I.value?(x(),S("div",Ne,"编辑："+T(I.value.name),1)):G("",!0),s("div",Le,[e[27]||(e[27]=s("label",{class:"form-label"},"组类型",-1)),n(g,{modelValue:v.value.setType,"onUpdate:modelValue":e[10]||(e[10]=a=>v.value.setType=a),options:k(l).setTypes},null,8,["modelValue","options"])]),s("div",Re,[e[28]||(e[28]=s("label",{class:"form-label"},"重量",-1)),h(s("input",{type:"number",class:"form-input","onUpdate:modelValue":e[11]||(e[11]=a=>v.value.weight=a),step:"0.5"},null,512),[[$,v.value.weight]])]),s("div",je,[e[29]||(e[29]=s("label",{class:"form-label"},"单位",-1)),n(g,{modelValue:v.value.unitId,"onUpdate:modelValue":e[12]||(e[12]=a=>v.value.unitId=a),options:k(l).units.map(a=>({value:a.id,label:a.name}))},null,8,["modelValue","options"])]),s("div",Ae,[e[30]||(e[30]=s("label",{class:"form-label"},"次数 (Reps)",-1)),h(s("input",{type:"number",class:"form-input","onUpdate:modelValue":e[13]||(e[13]=a=>v.value.reps=a)},null,512),[[$,v.value.reps]])]),s("div",qe,[n(y,{variant:"secondary",class:"flex-1",disabled:z.value,onClick:e[14]||(e[14]=a=>t.value=!1)},{default:d(()=>[...e[31]||(e[31]=[w("取消 ",-1)])]),_:1},8,["disabled"]),n(y,{variant:"primary",class:"flex-1",loading:z.value,onClick:ne},{default:d(()=>[...e[32]||(e[32]=[w("保存",-1)])]),_:1},8,["loading"])])]),_:1},8,["show"]),n(E,{show:u.value,onClose:e[18]||(e[18]=a=>u.value=!1)},{default:d(()=>[A.value?(x(),S("div",He,[e[35]||(e[35]=s("div",{class:"dialog-title f-title is-danger"},"最后一组",-1)),e[36]||(e[36]=s("div",{class:"dialog-message"},"这是今天最后一组，删除后将清除今日记录并返回首页，确定吗？",-1)),s("div",We,[n(y,{variant:"secondary",class:"flex-1",disabled:F.value,onClick:e[16]||(e[16]=a=>u.value=!1)},{default:d(()=>[...e[33]||(e[33]=[w("取消",-1)])]),_:1},8,["disabled"]),n(y,{variant:"danger",class:"flex-1",loading:F.value,onClick:K},{default:d(()=>[...e[34]||(e[34]=[w("确定删除 ",-1)])]),_:1},8,["loading"])])])):(x(),S("div",Ge,[e[39]||(e[39]=s("div",{class:"dialog-title f-title"},"确认删除",-1)),e[40]||(e[40]=s("div",{class:"dialog-message"},"确定要删除此组训练记录吗？",-1)),s("div",Je,[n(y,{variant:"secondary",class:"flex-1",disabled:F.value,onClick:e[17]||(e[17]=a=>u.value=!1)},{default:d(()=>[...e[37]||(e[37]=[w("取消",-1)])]),_:1},8,["disabled"]),n(y,{variant:"danger",class:"flex-1",loading:F.value,onClick:K},{default:d(()=>[...e[38]||(e[38]=[w("确定删除 ",-1)])]),_:1},8,["loading"])])]))]),_:1},8,["show"])])}}}),Xe=ye(Ke,[["__scopeId","data-v-efe161f9"]]);export{Xe as default};
